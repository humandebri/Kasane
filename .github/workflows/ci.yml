name: CI

on:
  pull_request:
  workflow_dispatch:

permissions: read-all

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  checks:
    name: Rust checks and tests
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache Rust artifacts
        uses: Swatinem/rust-cache@v2

      - name: RNG callsite guard
        run: scripts/check_rng_paths.sh

      - name: getrandom wasm feature guard
        run: scripts/check_getrandom_wasm_features.sh

      - name: DID sync guard
        run: scripts/check_did_sync.sh

      - name: Legacy RPC removal guard
        run: scripts/check_legacy_rpc_removed.sh

      - name: Alloy dependency isolation guard
        run: scripts/check_alloy_isolation.sh

      - name: Deny OP stack references
        shell: bash
        run: |
          set -euo pipefail
          DENY_PATTERN='op-revm|op_revm|op-node|op-geth|optimism|superchain|OpDeposit|L1BlockInfo'
          if grep -RInE "$DENY_PATTERN" \
            --exclude-dir=.git \
            --exclude-dir=target \
            --exclude-dir=vendor \
            --exclude-dir=node_modules \
            --exclude='ci-local.sh' \
            --exclude='pr0-differential-runbook.md' \
            crates docs scripts README.md Cargo.toml; then
            echo "[guard] forbidden OP stack reference found"
            exit 1
          fi

      - name: Install supply-chain tools
        run: cargo install --locked cargo-deny cargo-audit

      - name: Cargo deny
        run: cargo deny check

      - name: Cargo audit
        run: cargo audit --deny warnings --ignore RUSTSEC-2024-0388 --ignore RUSTSEC-2024-0436

      - name: Generate dependency SBOM snapshot
        run: cargo metadata --locked --format-version 1 > cargo-metadata.sbom.json

      - name: Generate vendor digest snapshot
        shell: bash
        run: |
          set -euo pipefail
          find vendor/revm -type f -print0 | sort -z | xargs -0 sha256sum > vendor-revm.sha256
          find vendor/ark-relations -type f -print0 | sort -z | xargs -0 sha256sum > vendor-ark-relations.sha256

      - name: Upload supply-chain snapshots
        uses: actions/upload-artifact@v4
        with:
          name: supply-chain-snapshots
          path: |
            cargo-metadata.sbom.json
            vendor-revm.sha256
            vendor-ark-relations.sha256

      - name: Run workspace tests
        run: cargo test -p evm-db -p ic-evm-core -p ic-evm-wrapper --locked --lib --tests

      - name: Check evm-rpc-e2e manifest builds
        run: cargo test --manifest-path crates/evm-rpc-e2e/Cargo.toml --no-run --locked

      - name: Canbench regression guard
        env:
          CANBENCH_MAX_REGRESSION_PCT: "2.0"
          CANBENCH_TARGET_IMPROVEMENT_PCT: "5.0"
        run: scripts/run_canbench_guard.sh

  release_guard:
    name: Release wasm guard
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: checks
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache Rust artifacts
        uses: Swatinem/rust-cache@v2

      - name: Enforce no dev-faucet endpoint in release wasm
        run: scripts/release_wasm_guard.sh
