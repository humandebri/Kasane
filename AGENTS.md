# AGENTS.md

このリポで作業するエージェント向けの最小ルール。
目的は「小さく、明確で、安全な変更」を維持すること。

## 1. 基本方針
- 変更は最小差分で行う。1つのPR/コミットで目的は1つに絞る。
- 既存仕様を優先し、推測で仕様を追加しない。
- 余計な依存を追加しない。必要性が説明できない新規ライブラリは禁止。
- 失敗時フォールバックや暫定shimは原則入れない。
- 破壊的変更（API/挙動/運用手順）を伴う場合は事前確認を取る。

## 2. 作業手順（必須）
1. 関連ファイルを読んで影響範囲を特定する。  
2. 変更前に一次情報を確認する（公式ドキュメント・既存仕様）。  
3. 実装は単一目的・最小差分で行う。  
4. 変更に対応するテストを追加/更新する。  
5. ローカルで検証コマンドを実行し、結果を共有する。  

## 3. このリポの標準検証コマンド
- まず実行:
  - `cargo check --workspace`
- ユニット/統合（主要）:
  - `scripts/ci-local.sh github`
- デプロイ前スモーク:
  - `scripts/predeploy_smoke.sh`
- スクリプト全体の使い方:
  - `scripts/README.md`

必要な範囲だけ実行し、重い検証は変更箇所に応じて選ぶこと。

### query 呼び出しルール（重要）
- canister の query 呼び出しは `icp-cli` ではなく **`dfx` を使う**。
- query メソッドは必ず `--query` を付ける。
- 例:
  - `dfx canister call --query <CANISTER_NAME_OR_ID> <METHOD> '(<ARGS>)'`
  - `dfx canister call --query <CANISTER_NAME_OR_ID> <METHOD> '(<ARGS>)' --network=<NETWORK>`

## 4. コーディング規約（要点）
- Rustは既存スタイルに合わせる（命名・モジュール配置・エラーハンドリング）。
- マジックナンバーを避け、既存の定数/設定を再利用する。
- `any`/無理な型キャスト相当の逃げを使わない（型安全を維持）。
- コメントは「なぜ」を短く書く。冗長な説明は避ける。

## 5. テスト方針
- 仕様変更ではなく、現行ビジネスロジックに沿ってアサーションを書く。
- テストが追加できない場合は、理由と代替検証手順を明記する。
- 失敗再現手順と修正後の確認手順をセットで残す。

## 6. コミュニケーション
- 報告は日本語で簡潔に行う。
- 不確実性がある場合は推測で進めず、確認事項として明示する。
- 自信が低い変更は先に相談し、影響範囲とロールバック手段を添える。
